import { useMemo } from "react";

import { configuration } from "../../application";
import { DialogProps } from "../dialog-api";
import { EntityRepresentative, RelationshipRepresentative } from "../utilities/dialog-utilities";
import { EntityProfileState, EntityProfileStateController, createEntityProfileController } from "../utilities/entity-profile-utilities";
import { RelationshipProfileState, RelationshipProfileStateController, createRelationshipProfileController, filterByModel } from "../utilities/relationship-profile-utilities";
import { LanguageString } from "@dataspecer/core/core/core-resource";
import { validateEntityState } from "../utilities/entity-utilities";
import { CmeModel } from "../../dataspecer/cme-model";

export interface EditAssociationProfileDialogState extends
  EntityProfileState<RelationshipRepresentative>,
  RelationshipProfileState<EntityRepresentative> { }

export interface EditAssociationProfileDialogController extends
  EntityProfileStateController<RelationshipRepresentative>,
  RelationshipProfileStateController<EntityRepresentative> { }

export function useEditAssociationProfileDialogController({ changeState }:
  DialogProps<EditAssociationProfileDialogState>): EditAssociationProfileDialogController {

  return useMemo(() => {

    const entityProfileController = createEntityProfileController(
      changeState, configuration().relationshipNameToIri);

    const relationshipProfileController = createRelationshipProfileController(
      changeState, filterByModel, filterByModel);

    const setModel = (model: CmeModel) => {
      entityProfileController.setModel(model);
      relationshipProfileController.onModelDidChange(model);
      changeState(state => configuration().relationshipProfileToIri(state));
    };

    const setName = (setter: (value: LanguageString) => LanguageString): void => {
      changeState(state => {
        const result = { ...state, name : setter(state.name) };
        return configuration().relationshipProfileToIri(result);
      });
    };

    const setDomain = (value: EntityRepresentative): void => {
      relationshipProfileController.setDomain(value);
      changeState(state => configuration().relationshipProfileToIri(state));
    };

    const setIri = (iri: string) => {
      changeState((state) => validateEntityState({ ...state, iri, isIriAutogenerated: false }));
    };

    return {
      ...entityProfileController,
      ...relationshipProfileController,
      setModel,
      setName,
      setDomain,
      setIri,
    };
  }, [changeState]);
}
